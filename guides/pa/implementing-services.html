

<!DOCTYPE html>

	<html lang="en-GB">

	<head>
		<meta charset="UTF-8">
		<meta http-equiv="x-ua-compatible" content="ie=edge">
		<meta name="viewport" content="width=device-width, minimum-scale=1.0">
		
			<title>Implementing the services | AEVI AppFlow</title>
		
		
			<meta name="description" content="How to integrate your payment application with AppFlow">
		
		
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono|IBM+Plex+Sans:400,400i,500,500i,700,700i">
		<link rel="stylesheet" href="/pos-android-sdk/dox-theme/assets/css/style.css">
		<link rel="icon" href="/pos-android-sdk/icon_large.png" sizes="32x32">
		<link rel="icon" href="/pos-android-sdk/icon_large.png" sizes="192x192">
		<link rel="apple-touch-icon-precomposed" href="/pos-android-sdk/icon_large.png">
		<meta name="msapplication-TileImage" content="/pos-android-sdk/icon_large.png">
	</head>
	<body>
		
			<div class="c-offcanvas">
				<div class="c-offcanvas__inner">
					
						<ul class="c-nav c-nav--stacked u-mx-auto">
							
								<li><a href="/pos-android-sdk/intro">Introduction</a></li>
							
								<li><a href="/pos-android-sdk/explore">Explore</a></li>
							
								<li><a href="/pos-android-sdk/downloads">Downloads</a></li>
							
								<li><a href="/pos-android-sdk/support">Support</a></li>
							
						</ul><!-- /.c-nav -->
					
					
						
							<a href="/reference" class="c-btn c-btn--md c-btn--gray u-text-md">
								Reference
								<div class="c-btn__icon">
									<i class="o-icon o-icon--folder"></i>
								</div>
							</a>
						
					
				</div><!-- /.c-offcanvas__inner -->
			</div><!-- /.c-offcanvas -->
		

		
			<header class="c-header">
				<div class="o-container">
					<div class="o-row">
						<div class="o-col-12">
							<div class="u-flex u-items-center">
								
									<div class="c-logo">
										<a href="/pos-android-sdk/" class="c-logo__link">
											<img src="/pos-android-sdk/aevi_logo.svg">
										</a><!-- /.c-logo__link -->
									</div><!-- /.c-logo -->
								
								
									<div class="u-flex u-items-center u-ml-auto">
										
											<ul class="c-nav u-mb-0 u-hidden u-block@lg">
												
													
													<li class=""><a href="/pos-android-sdk/intro">Introduction</a></li>
												
													
													<li class=""><a href="/pos-android-sdk/explore">Explore</a></li>
												
													
													<li class=""><a href="/pos-android-sdk/downloads">Downloads</a></li>
												
													
													<li class=""><a href="/pos-android-sdk/support">Support</a></li>
												
											</ul><!-- /.c-nav -->
										
										
											<div class="u-ml-5 u-hidden u-block@lg">
												
													<a href="/pos-android-sdk/reference" class="c-btn c-btn--md c-btn--gray u-text-md">
														Reference
														<div class="c-btn__icon">
															<i class="o-icon o-icon--folder"></i>
														</div>
													</a>
												
											</div>
										
									</div>
								
								<button class="c-hamburger-icon c-hamburger-icon--slider js-hamburger-icon js-offcanvas-toggle u-ml-auto u-hidden@lg" type="button">
									<span class="c-hamburger-icon__box">
										<span class="c-hamburger-icon__inner"></span>
									</span><!-- /.c-hamburger-icon__box -->
								</button><!-- /.c-hamburger-icon -->
							</div>
						</div><!-- /.o-col -->
					</div><!-- /.o-row -->
				</div><!-- /.o-container -->
			</header><!-- /.c-header -->
		







	
		<div class="c-hero u-bg-gray-30 u-pt-16 u-pb-10">
	
		<div class="o-container">
			<div class="o-row">
				<div class="o-col-10@lg o-col-9@xl">
					
						<h2 class="u-text-lg u-text-xl@sm">Payment Applications</h2>
					
					
						<div class="u-h6">
							<p>Implementing the services</p>
						</div>
					
					
					
				</div><!-- /.o-col -->
			</div><!-- /.o-row -->
		</div><!-- /.o-container -->
	</div>






	<div class="u-pt-8 u-pb-5">
		<div class="o-container">
			<div class="o-row">
				
					<div class="o-col-8@lg o-col-7@xl">
						<div class="c-post u-mb-3@lg js-post">
							<h1 id="implementing-the-services">Implementing the services</h1>

<p>Now that you have decided what stages are relevant for your application and set up the content provider, it is time to implement the actual service.
The service (which is an Android Service) is what FPS will be calling into for passing flow data and how your application can send back a response.</p>

<h2 id="determining-when-to-get-called">Determining when to get called</h2>

<p>Depending on the type of payment application, different flow stages are relevant.
All payment applications must support the <code class="highlighter-rouge">TRANSACTION_PROCESSING</code> stage, which is the point at which money is transferred during a payment flow. As an example. for a <code class="highlighter-rouge">sale</code> flow, it is when the customer pays the merchant via some payment method such as card or cash.</p>

<p>AppFlow does not dictate what payment methods a payment application uses, as long as it accurately reports the correct payment method(s) in the app info and transaction responses.</p>

<h3 id="payment-card-reading">Payment card reading</h3>
<p>For traditional payment applications using payment cards, there is an optional (but recommended) stage called <code class="highlighter-rouge">PAYMENT_CARD_READING</code>.
Read more about this <a href="/pos-android-sdk/technical/payment-card-reading">here</a>.</p>

<h3 id="non-payment-functions">Non-payment functions</h3>

<p>For other functions, such as <code class="highlighter-rouge">reversal</code> (<code class="highlighter-rouge">void</code>), <code class="highlighter-rouge">tokenisation</code>, etc, the <code class="highlighter-rouge">GENERIC</code> stage is used.
See <a href="/pos-android-sdk/technical/request-types">Request Types</a> for the different generic types and whether your application can support any of these.</p>

<h2 id="the-service">The service</h2>

<p>Below is an example from the <a href="https://github.com/AEVI-AppFlow/pos-android-sdk/blob/master/PaymentServiceSample/src/main/java/com/aevi/sdk/pos/flow/paymentservicesample/service/PaymentService.java#L29">Payment Service Sample</a> of how to implement a service that exposes the three stages.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaymentService</span> <span class="kd">extends</span> <span class="n">BasePaymentFlowService</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPaymentCardReading</span><span class="o">(</span><span class="n">CardReadingModel</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// TODO handle</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onTransactionProcessing</span><span class="o">(</span><span class="n">TransactionProcessingModel</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// TODO handle</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onGeneric</span><span class="o">(</span><span class="n">GenericStageModel</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// TODO handle</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="expose-in-manifest">Expose in manifest</h2>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;service</span>
  <span class="na">android:name=</span><span class="s">".service.PaymentService"</span>
  <span class="na">android:exported=</span><span class="s">"true"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;intent-filter&gt;</span>
    <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">"com.aevi.sdk.flow.action.PROCESS_TRANSACTION"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">"com.aevi.sdk.flow.action.READ_PAYMENT_CARD"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">"com.aevi.sdk.flow.action.PROCESS_GENERIC"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/intent-filter&gt;</span>
<span class="nt">&lt;/service&gt;</span>
</code></pre></div></div>

<h2 id="transaction-processing">Transaction processing</h2>
<p>The request for a payment flow comes in the form of a <code class="highlighter-rouge">TransactionRequest</code> object and can be fetched via <code class="highlighter-rouge">TransactionProcessingModel.getTransactionRequest()</code>. There are two different ids defined in this class - please see <a href="/pos-android-sdk/technical/transactions">Transactions</a> for more information about what the ids are how they can be used.</p>

<p>You can determine what type of transaction it is from <code class="highlighter-rouge">TransactionRequest.getFlowType()</code>. This will map to one of the types defined in <a href="/pos-android-sdk/technical/request-types">Request Types</a> for where the request class if of type <code class="highlighter-rouge">Payment</code>.</p>

<p>The amounts relevant for the transaction are available via the <code class="highlighter-rouge">TransactionRequest.getAmounts()</code> method. Note that it is very important to understand the way AppFlow represents amounts and what the structure of it means for a payment application. See <a href="parsing-amounts">parsing amounts</a> for details.</p>

<p>It is possible that <code class="highlighter-rouge">TransactionRequest.getCard()</code> contains some form of card data either if a card was read in the payment card reading stage <em>or</em> the POS app provided a <a href="handling-card-tokens">card token</a> to use for payment. You can check if the <code class="highlighter-rouge">Card</code> object contains any data via the <code class="highlighter-rouge">Card.isEmpty()</code> method, or check if a token is set via the <code class="highlighter-rouge">Card.getCardToken()</code> method.</p>

<p>In addition, depending on the use cases for your payment application, the following information may also be available;</p>
<ul>
  <li>Basket data (via <code class="highlighter-rouge">getBasket()</code>)</li>
  <li>Customer data (via <code class="highlighter-rouge">getCustomer()</code>)</li>
  <li>Custom/bespoke data (via <code class="highlighter-rouge">getAdditionalData()</code>)</li>
</ul>

<h3 id="building-the-transaction-processing-response">Building the transaction processing response</h3>

<p>When your payment app has finished processing the payment and determined the outcome, you should construct an appropriate <code class="highlighter-rouge">TransactionResponse</code> object using the <code class="highlighter-rouge">TransactionResponseBuilder</code> retrieved via <code class="highlighter-rouge">TransactionProcessingModel.getTransactionResponseBuilder()</code>.</p>

<p>At a minimum, the outcome must be set via calling either one of the approve methods or the decline method on the builder. If a specific response code is supported via a defined protocol, such as <em>ISO-8583</em>, this should be set via the <code class="highlighter-rouge">withResponseCode()</code> method. In addition, free text information about the outcome can be provided via the <code class="highlighter-rouge">withOutcomeMessage()</code> method.</p>

<div class="callout callout--danger">
  <p>The amounts structure in the response is very important. If the transaction was approved with the full amounts charged, you should use the <i>request</i> amounts (from <code>TransactionRequest</code>) to pass in via the <code>approve(Amounts processedAmounts, String... paymentMethod)</code> method in the builder. </p>

  <p>This is to preserve the integrity of the amounts structure. If the payment application response amounts use a different structure for the processed amounts (for example, sets the total approved as base and ignores the additional amounts), it will be difficult for other AppFlow applications to match additional amounts (such as a donation) and see whether they were processed correctly. It also creates issues for split flows (split bill).</p>
</div>

<p>If your payment application (host/gateway) supports <em>partial auth</em> and such a scenario occurs, then you can of course not use the request amounts as they were. In this case, it is recommended that you first “fill up” the base amount with the amounts authorised, and then split any remaining amounts uniformly (as a fraction) of the requested additional amounts.</p>

<p>If the payment method used for the transaction was a payment card (and it was read in this stage and not in payment card reading stage), it is strongly recommended that the following fields at a minimum are populated in the <code class="highlighter-rouge">Card</code> model;</p>
<ul>
  <li>Card network / scheme</li>
  <li>Card entry method</li>
  <li>Card token</li>
</ul>

<p>In addition, it is recommended that any other relevant information the payment application may have about a transaction is added to the transaction references via the <code class="highlighter-rouge">withReference()</code> method. See <a href="/pos-android-sdk/technical/transactionresponse-references">TransactionResponse References</a> for details. You may also set any custom and bespoke references your payment application and/or host/gateway may have defined.</p>

<p>The response is then sent back via calling <code class="highlighter-rouge">TransactionProcessingModel.sendResponse()</code>. This method will generate the response from the builder and send it back to FPS.</p>

<h2 id="payment-card-reading-1">Payment card reading</h2>
<p>As for transaction processing, the request type is <code class="highlighter-rouge">TransactionRequest</code>, which can be fetched via <code class="highlighter-rouge">CardReadingModel.getTransactionRequest()</code>.</p>

<h3 id="setting-the-response">Setting the response</h3>
<p>If this stage is supported, the expectation is that a <code class="highlighter-rouge">Card</code> object is created and passed back on successful card reading. The card reading can have three outcomes, reflected by these three methods in <code class="highlighter-rouge">CardReadingModel</code></p>

<ul>
  <li><code class="highlighter-rouge">approveWithCard(Card)</code> - If a card was read successfully</li>
  <li><code class="highlighter-rouge">skipCardReading()</code> - If card reading should be bypassed in this stage (for whatever reason)</li>
  <li><code class="highlighter-rouge">declineTransaction(String)</code> - If card reading failed and transaction should be declined</li>
</ul>

<p>All these methods above will also send the response straight back to FPS, so there is no need to call any further methods in the model to finalise.</p>

<p>All the various fields in <code class="highlighter-rouge">Card</code> are optional, but for this to be useful for any purpose, we recommend the following fields at a minimum are populated;</p>
<ul>
  <li>Card network / scheme</li>
  <li>Card entry method</li>
  <li>Card token</li>
</ul>

<p>It should also be noted that it is expected that the payment application keeps track of what happened in this stage and acts accordingly in the processing stage later.</p>

<h2 id="generic-scenarios">Generic scenarios</h2>

<p>The response here is managed via <code class="highlighter-rouge">GenericStageModel</code>. In terms of how to parse the request and create a response for any given type, please see the <a href="/pos-android-sdk/technical/request-types">Request Types</a> page which details all the supported types.</p>


							

						</div><!-- /.c-post -->
					</div><!-- /.o-col -->
				
				
					<div class="o-col-3@lg o-offset-1@lg o-offset-2@xl">
						<ul class="c-page-nav u-sticky u-pin-t-6 u-mt-4 u-mt-1@lg u-mb-1 u-mb-4@lg">
							
							
							
								
								
									
										<li>
											<a href="/pos-android-sdk/guides/pa/pre-requisites">
												<p class="c-page-nav__heading">Pre-requisites</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li>
											<a href="/pos-android-sdk/guides/pa/api-overview">
												<p class="c-page-nav__heading">API Overview</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li>
											<a href="/pos-android-sdk/guides/pa/expose-app-info">
												<p class="c-page-nav__heading">Expose app info</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li>
											<a href="/pos-android-sdk/guides/pa/implementing-services">
												<p class="c-page-nav__heading">Implementing the services</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li class="is-active">
											<a href="/pos-android-sdk/guides/pa/handling-events">
												<p class="c-page-nav__heading">Handling events</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li class="is-active">
											<a href="/pos-android-sdk/guides/pa/receipts">
												<p class="c-page-nav__heading">Receipts</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li class="is-active">
											<a href="/pos-android-sdk/guides/pa/application-guidelines">
												<p class="c-page-nav__heading">Application Guidelines</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li class="is-active">
											<a href="/pos-android-sdk/guides/pa/next-steps">
												<p class="c-page-nav__heading">Next steps</p>
											</a>
										</li>
									
									
								
							
						</ul><!-- /.c-page-nav -->
					</div><!-- /.o-col -->
				
			</div><!-- /.o-row -->
		</div><!-- /.o-container -->
	</div>



	
	
		<div class="u-bg-primary u-text-white u-pt-3 u-pt-4@sm u-pb-3 u-pb-4@sm">
			<div class="o-container">
				<div class="o-row">
					<div class="o-col-12 u-text-center">
						<div class="u-inline-block u-flex@sm">
							
							
							 	
							
							 	
							
							 	
							
							 	
								  
									
									
									
									
										<a href="/pos-android-sdk/guides/pa/expose-app-info" class="c-arrow-link c-arrow-link--prev u-mr-auto">Expose app info</a>
									
									
										<a href="/pos-android-sdk/guides/pa/handling-events" class="c-arrow-link c-arrow-link--next u-ml-auto">Handling events</a>
									
								
							
							 	
							
							 	
							
							 	
							
							 	
							
						</div>
					</div><!-- /.o-col -->
				</div><!-- /.o-row -->
			</div><!-- /.o-container -->
		</div>
		

		
			<footer class="c-footer">
				<div class="o-container">
					<div class="o-row">
						<div class="o-col-12 u-mt-6 u-mt-8@md u-mb-4 u-mb-6@md">
							
								<p class="c-logo u-mb-1">
									AEVI AppFlow
								</p><!-- /.c-logo -->
							
							
								<p>Copyright &copy;2019. - AEVI International GmbH <br>All rights reserved.</p>
							
						</div><!-- /.o-col -->
					</div><!-- /.o-row -->
				</div><!-- /.o-container -->
			</footer><!-- /.c-footer -->
		

		<script type="text/javascript" src="/pos-android-sdk/dox-theme/assets/js/vendor/jquery-3.3.1.min.js"></script>
		<script type="text/javascript" src="/pos-android-sdk/dox-theme/assets/js/scripts.min.js"></script>

		

	</body>
</html>

	

