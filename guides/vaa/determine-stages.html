

<!DOCTYPE html>

	<html lang="en-GB">

	<head>
		<meta charset="UTF-8">
		<meta http-equiv="x-ua-compatible" content="ie=edge">
		<meta name="viewport" content="width=device-width, minimum-scale=1.0">
		
			<title>Determine flow stages | AEVI AppFlow</title>
		
		
			<meta name="description" content="Specific value added applications">
		
		
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono|IBM+Plex+Sans:400,400i,500,500i,700,700i">
		<link rel="stylesheet" href="/pos-android-sdk/dox-theme/assets/css/style.css">
		<link rel="icon" href="/pos-android-sdk/icon_large.png" sizes="32x32">
		<link rel="icon" href="/pos-android-sdk/icon_large.png" sizes="192x192">
		<link rel="apple-touch-icon-precomposed" href="/pos-android-sdk/icon_large.png">
		<meta name="msapplication-TileImage" content="/pos-android-sdk/icon_large.png">
	</head>
	<body>
		
			<div class="c-offcanvas">
				<div class="c-offcanvas__inner">
					
						<ul class="c-nav c-nav--stacked u-mx-auto">
							
								<li><a href="/pos-android-sdk/intro">Introduction</a></li>
							
								<li><a href="/pos-android-sdk/explore">Explore</a></li>
							
								<li><a href="/pos-android-sdk/downloads">Downloads</a></li>
							
								<li><a href="/pos-android-sdk/support">Support</a></li>
							
						</ul><!-- /.c-nav -->
					
					
						
							<a href="/reference" class="c-btn c-btn--md c-btn--gray u-text-md">
								Reference
								<div class="c-btn__icon">
									<i class="o-icon o-icon--folder"></i>
								</div>
							</a>
						
					
				</div><!-- /.c-offcanvas__inner -->
			</div><!-- /.c-offcanvas -->
		

		
			<header class="c-header">
				<div class="o-container">
					<div class="o-row">
						<div class="o-col-12">
							<div class="u-flex u-items-center">
								
									<div class="c-logo">
										<a href="/pos-android-sdk/" class="c-logo__link">
											<img src="/pos-android-sdk/aevi_logo.svg">
										</a><!-- /.c-logo__link -->
									</div><!-- /.c-logo -->
								
								
									<div class="u-flex u-items-center u-ml-auto">
										
											<ul class="c-nav u-mb-0 u-hidden u-block@lg">
												
													
													<li class=""><a href="/pos-android-sdk/intro">Introduction</a></li>
												
													
													<li class=""><a href="/pos-android-sdk/explore">Explore</a></li>
												
													
													<li class=""><a href="/pos-android-sdk/downloads">Downloads</a></li>
												
													
													<li class=""><a href="/pos-android-sdk/support">Support</a></li>
												
											</ul><!-- /.c-nav -->
										
										
											<div class="u-ml-5 u-hidden u-block@lg">
												
													<a href="/pos-android-sdk/reference" class="c-btn c-btn--md c-btn--gray u-text-md">
														Reference
														<div class="c-btn__icon">
															<i class="o-icon o-icon--folder"></i>
														</div>
													</a>
												
											</div>
										
									</div>
								
								<button class="c-hamburger-icon c-hamburger-icon--slider js-hamburger-icon js-offcanvas-toggle u-ml-auto u-hidden@lg" type="button">
									<span class="c-hamburger-icon__box">
										<span class="c-hamburger-icon__inner"></span>
									</span><!-- /.c-hamburger-icon__box -->
								</button><!-- /.c-hamburger-icon -->
							</div>
						</div><!-- /.o-col -->
					</div><!-- /.o-row -->
				</div><!-- /.o-container -->
			</header><!-- /.c-header -->
		







	
		<div class="c-hero u-bg-gray-30 u-pt-16 u-pb-10">
	
		<div class="o-container">
			<div class="o-row">
				<div class="o-col-10@lg o-col-9@xl">
					
						<h2 class="u-text-lg u-text-xl@sm">Value Added Services</h2>
					
					
						<div class="u-h6">
							<p>Determine what stages to use</p>
						</div>
					
					
					
				</div><!-- /.o-col -->
			</div><!-- /.o-row -->
		</div><!-- /.o-container -->
	</div>






	<div class="u-pt-8 u-pb-5">
		<div class="o-container">
			<div class="o-row">
				
					<div class="o-col-8@lg o-col-7@xl">
						<div class="c-post u-mb-3@lg js-post">
							<h1 id="where-does-your-application-fit-into-appflow">Where does your application fit into AppFlow?</h1>

<p>At the heart of AppFlow are <em>flows</em>, which consist of one to many <em>stages</em>. An understanding of this is required in order to identify
how to set up your application for AppFlow.</p>

<p>First of, make sure you have read the <a href="/pos-android-sdk/intro">Introduction</a> and associated pages to gain an understanding of how AppFlow operates.</p>

<p>Now it is hopefully clear what a flow is, what stages there are and what these stages provides. Before we move onto implementation, you must decide when it is relevant for your application to get called.</p>

<h2 id="determine-relevant-flows">Determine relevant flows</h2>

<p>The <a href="/pos-android-sdk/technical/request-types">Request Types</a> page outlines the defined AppFlow functions, which via the associated request types defines the <em>flows</em>.</p>

<p>Your flow service will need to define what flow types are supported and from that, what flow stages to be called for.</p>

<p>Is is important to understand that there are two factors that will impact for what flows your service gets called;</p>
<ul>
  <li>The flows defined via the <code class="highlighter-rouge">AppFlow Configuration Provider</code> (in the case of the bundle, this is the <code class="highlighter-rouge">AppFlow Settings</code> application)</li>
  <li>What flow types your service reports as supported</li>
</ul>

<p>Some types of flow service will only ever be relevant for a particular type of flows. An example is loyalty, which is applicable when a customer is purchasing goods or services.
These services should define the exact set of supported flow types to ensure they are only called for the relevant functions (like <code class="highlighter-rouge">sale</code>).</p>

<p>Other types of flow services, such as receipt handling services or feedback/ratings services, are not generally restricted to a particular set of functions or flows.
For these services, it is better to not define supported flow types, which means they can be called for <em>any</em> flow.
Instead, what flows they are called for is <em>entirely</em> down to the flow configurations for the particular environment/device.</p>

<h2 id="determine-relevant-stages-by-function">Determine relevant stages by function</h2>

<p>Once you have decided what flow types are relevant, you need to select for what stages in those flows your service should be called.</p>

<p>Most value added services will fit into one of the payment stages for standard financial transactions.</p>

<p>The following payment stages, as described in the AppFlow intro, may be relevant for value added services</p>

<ul>
  <li><code class="highlighter-rouge">PRE_FLOW</code> (rarely)</li>
  <li><code class="highlighter-rouge">SPLIT</code></li>
  <li><code class="highlighter-rouge">PRE_TRANSACTION</code></li>
  <li><code class="highlighter-rouge">POST_CARD_READING</code></li>
  <li><code class="highlighter-rouge">POST_TRANSACTION</code></li>
  <li><code class="highlighter-rouge">POST_FLOW</code> (rarely)</li>
</ul>

<p>In addition, we have the generic and status update stages that may be relevant for some use cases</p>

<ul>
  <li><code class="highlighter-rouge">GENERIC</code></li>
  <li><code class="highlighter-rouge">POST_GENERIC</code></li>
  <li><code class="highlighter-rouge">STATUS_UPDATE</code></li>
</ul>

<p>Below is a quick outline of what stages are relevant for particular functions that AppFlow supports.</p>

<ul>
  <li>Reacting to outcomes -&gt; <code class="highlighter-rouge">POST_TRANSACTION</code> (per customer), <code class="highlighter-rouge">POST_FLOW</code> (per flow), <code class="highlighter-rouge">POST_GENERIC</code></li>
  <li>Adding additional amounts -&gt; <code class="highlighter-rouge">PRE_TRANSACTION</code>, <code class="highlighter-rouge">POST_CARD_READING</code>, <code class="highlighter-rouge">PRE_FLOW</code> (rarely)</li>
  <li>Adding basket items -&gt; <code class="highlighter-rouge">PRE_TRANSACTION</code>, <code class="highlighter-rouge">POST_CARD_READING</code>, <code class="highlighter-rouge">PRE_FLOW</code> (rarely)</li>
  <li>Paying amounts -&gt; <code class="highlighter-rouge">PRE_TRANSACTION</code>, <code class="highlighter-rouge">POST_CARD_READING</code></li>
  <li>Applying discounts -&gt; <code class="highlighter-rouge">PRE_TRANSACTION</code>, <code class="highlighter-rouge">POST_CARD_READING</code></li>
  <li>Add/update customer details -&gt; <code class="highlighter-rouge">PRE_TRANSACTION</code>, <code class="highlighter-rouge">POST_CARD_READING</code>, <code class="highlighter-rouge">PRE_FLOW</code> (rarely)</li>
  <li>Add arbitrary data -&gt; <code class="highlighter-rouge">PRE_TRANSACTION</code>, <code class="highlighter-rouge">POST_CARD_READING</code>, <code class="highlighter-rouge">PRE_FLOW</code> (rarely)</li>
  <li>Handle a specific request -&gt; <code class="highlighter-rouge">GENERIC</code></li>
  <li>Being notified of POS status changes -&gt; <code class="highlighter-rouge">STATUS_UPDATE</code></li>
</ul>

<h2 id="determine-relevant-stages-by-use-case">Determine relevant stages by use case</h2>

<p>This section outlines some common use cases and how they fit into AppFlow.</p>

<h3 id="loyalty">Loyalty</h3>
<p>A loyalty application typically provides three main functions:</p>

<ul>
  <li>Applying discounts from customer earned loyalty points or rewards</li>
  <li>Assigning newly earned points/rewards to a customer</li>
  <li>Allowing new customers to sign up to the loyalty scheme</li>
</ul>

<p>Loyalty is <em>typically</em> only relevant for the <code class="highlighter-rouge">sale</code> flow, but depending on industry/context, possibly also;</p>
<ul>
  <li><code class="highlighter-rouge">motoSale</code></li>
  <li><code class="highlighter-rouge">preAuthorisation</code></li>
  <li><code class="highlighter-rouge">preAuthCompletion</code></li>
</ul>

<p>Applying discounts, has to be done prior to the payment app performing its processing of the payment. Therefore, your application should support the <code class="highlighter-rouge">POST_CARD_READING</code> stage, as at that time all the data to help identify the customer will be available. This can be customer data from the POS app, card token from the card reading stage, or the loyalty app may provide its own mechanism to identify a customer. If card tokens are not relevant, <code class="highlighter-rouge">PRE_TRANSACTION</code> is an equally good candidate.</p>

<p>To apply discounts, you should make use of the <code class="highlighter-rouge">PreTransactionModel</code> where you have two options depending on how your loyalty scheme works.</p>

<ul>
  <li>Pay off all or a portion of the requested amounts</li>
  <li>Apply discount to basket items</li>
</ul>

<p>In the first case, you should use the <code class="highlighter-rouge">setAmountsPaid()</code> method, and in the latter case make use of the <code class="highlighter-rouge">addItemsToExistingBasket()</code> where you would add a discount line item with a negative amount to the main basket.</p>

<p>For assigning points and/or signing up new customers, <code class="highlighter-rouge">POST_TRANSACTION</code> should be used. At this stage, the outcome of the transaction is known and the payment app may have provided a card token as well as part of the <code class="highlighter-rouge">TRANSACTION_PROCESSING</code>.</p>

<h3 id="tipping">Tipping</h3>
<p>If a POS application does not provide tipping as a function, a flow service may choose to offer this separately.</p>

<p>Tipping is mainly relevant for the <code class="highlighter-rouge">sale</code> and <code class="highlighter-rouge">preAuthCompletion</code> flows.</p>

<p>The <code class="highlighter-rouge">PRE_TRANSACTION</code> stage is the most appropriate choice for general flows, but where it is not available, <code class="highlighter-rouge">PRE_FLOW</code> is also an option.</p>

<p>To apply a tip, see the <code class="highlighter-rouge">setAdditionalAmount()</code> or <code class="highlighter-rouge">setAdditionalAmountAsBaseFraction()</code> methods in the stage models.</p>

<h3 id="receipts">Receipts</h3>
<p>AppFlow enables handling of receipts to be managed by a flow service rather than the payment application or POS application. This is useful for receipt services that allow customers to gather all their receipts in a single location. It is also encouraged for more traditional receipt handling (like printing), as it means integration with printers / printing APIs can be done in a single application as opposed to embedding this functionality in  the POS/payment application.</p>

<p>Receipt handling is typically not restricted to a specific set of flows, which is why we would recommend that your service do not report any flow types so that it can be called for any flow.</p>

<p>Receipt handling flow services should be called in the <code class="highlighter-rouge">POST_TRANSACTION</code> stage, when the transaction outcome is known.</p>

<p>There are quite a few considerations to be made for receipt handling in AppFlow - please see <a href="/pos-android-sdk/technical/receipt-considerations">Considerations for receipt applications</a> for in-depth info.</p>

<h3 id="feedback--ratings">Feedback / Ratings</h3>
<p>Various services can be made available allowing acquirers/merchants to get customer feedback at the end of a transaction, typically via some rating system.</p>

<p>What type of flows this should be called for will be down to the acquirers, meaning it is best if your service does not report any supported flow types.</p>

<p>For payment flows, if feedback is desired <em>per customer</em>, then <code class="highlighter-rouge">POST_TRANSACTION</code> is the relevant stage, or if feedback is desired for the overall payment, then <code class="highlighter-rouge">POST_FLOW</code> is more appropriate.</p>

<p>For generic flows, <code class="highlighter-rouge">POST_GENERIC</code> is the stage to look for.</p>

<h3 id="ads--promotions">Ads / Promotions</h3>
<p>A flow service can provide ads and promotions that can be read and shown by other services in the flow. As an example, a receipt application might add it to the receipt.</p>

<p>TBD - flows and stages.</p>

<h3 id="analytics--reporting">Analytics / Reporting</h3>
<p>It is possible for a flow service to gather and report information and statistics around transactions. As this would deal with potentially sensitive customer data, this would for the most case require a special acquirer application(s).</p>

<p>As these services are typically run for all flows, flow types should be left empty.</p>

<p>These applications can run asynchronously in the <code class="highlighter-rouge">POST_FLOW</code> stage, meaning that they can accept the <code class="highlighter-rouge">PaymentResponse</code> data, and let the flow finish whilst the service processes the data in the background. This is to ensure that such activities do not delay the flow, which would have a negative impact on the sale experience.</p>

<p>In addition, these types of applications would also be suitable for the <code class="highlighter-rouge">POST_GENERIC</code> stage for the generic flows.</p>

<h3 id="splitting-bills">Splitting Bills</h3>
<p>A split bill application allows customers, typically in a restaurant/cafe setting, to split a table bill amongst them. A <code class="highlighter-rouge">Payment</code> will be broken down into a <code class="highlighter-rouge">Transaction</code> per customer, where the split application dictates the amounts / basket items for each transaction. The <code class="highlighter-rouge">Payment</code> will be completed once the total requested amounts have been met, or if it is cancelled.</p>

<p>There is a specific designed stage for split applications - <code class="highlighter-rouge">SPLIT</code>, which is called repeatedly until the <code class="highlighter-rouge">Payment</code> is completed. Please see <a href="/pos-android-sdk/technical/split-considerations">Considerations for split applications</a> for more information how to write a best practice split application.</p>

<h2 id="exposing-custom-data-or-function">Exposing custom data or function</h2>

<p>A value added service can expose custom data or a function (with associated user interface) via a generic flow.
This would allow POS apps and other initiating apps to seamlessly interact with your application without a need for bespoke integration.</p>

<p>Some examples for this may be;</p>
<ul>
  <li>Allowing an app to query for data, like customer loyalty point balance or inventory details</li>
  <li>Allowing merchants/customers to interact with your application for specific functions like updating customer details or updating inventory</li>
</ul>

<p>In both these cases, a generic flow would be used and the application would be called in the <code class="highlighter-rouge">GENERIC</code> stage. It is then up to the application whether
it simply returns back requested data directly, or if it launches a user interface for direct interaction.</p>

<p>To facilitate this, your flow service must also define and report a <em>custom request type</em> via the <code class="highlighter-rouge">PaymentFlowServiceInfo</code>, for which FPS will
generate an ad-hoc flow.</p>

							

						</div><!-- /.c-post -->
					</div><!-- /.o-col -->
				
				
					<div class="o-col-3@lg o-offset-1@lg o-offset-2@xl">
						<ul class="c-page-nav u-sticky u-pin-t-6 u-mt-4 u-mt-1@lg u-mb-1 u-mb-4@lg">
							
							
							
								
								
									
										<li>
											<a href="/pos-android-sdk/guides/vaa/pre-requisites">
												<p class="c-page-nav__heading">Pre-requisites</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li>
											<a href="/pos-android-sdk/guides/vaa/api-overview">
												<p class="c-page-nav__heading">API Overview</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li>
											<a href="/pos-android-sdk/guides/vaa/determine-stages">
												<p class="c-page-nav__heading">Determine flow stages</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li class="is-active">
											<a href="/pos-android-sdk/guides/vaa/expose-app-info">
												<p class="c-page-nav__heading">Expose app info</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li class="is-active">
											<a href="/pos-android-sdk/guides/vaa/implementing-flow-services">
												<p class="c-page-nav__heading">Implementing the services</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li class="is-active">
											<a href="/pos-android-sdk/guides/vaa/interacting-stage-models">
												<p class="c-page-nav__heading">Interacting with stage models</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li class="is-active">
											<a href="/pos-android-sdk/guides/vaa/handling-events">
												<p class="c-page-nav__heading">Handling events</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li class="is-active">
											<a href="/pos-android-sdk/guides/vaa/flow-response-listeners">
												<p class="c-page-nav__heading">Adding response listeners</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li class="is-active">
											<a href="/pos-android-sdk/guides/vaa/application-guidelines">
												<p class="c-page-nav__heading">Application Guidelines</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li class="is-active">
											<a href="/pos-android-sdk/guides/vaa/next-steps">
												<p class="c-page-nav__heading">Next steps</p>
											</a>
										</li>
									
									
								
							
						</ul><!-- /.c-page-nav -->
					</div><!-- /.o-col -->
				
			</div><!-- /.o-row -->
		</div><!-- /.o-container -->
	</div>



	
	
		<div class="u-bg-primary u-text-white u-pt-3 u-pt-4@sm u-pb-3 u-pb-4@sm">
			<div class="o-container">
				<div class="o-row">
					<div class="o-col-12 u-text-center">
						<div class="u-inline-block u-flex@sm">
							
							
							 	
							
							 	
							
							 	
								  
									
									
									
									
										<a href="/pos-android-sdk/guides/vaa/api-overview" class="c-arrow-link c-arrow-link--prev u-mr-auto">API Overview</a>
									
									
										<a href="/pos-android-sdk/guides/vaa/expose-app-info" class="c-arrow-link c-arrow-link--next u-ml-auto">Expose app info</a>
									
								
							
							 	
							
							 	
							
							 	
							
							 	
							
							 	
							
							 	
							
							 	
							
						</div>
					</div><!-- /.o-col -->
				</div><!-- /.o-row -->
			</div><!-- /.o-container -->
		</div>
		

		
			<footer class="c-footer">
				<div class="o-container">
					<div class="o-row">
						<div class="o-col-12 u-mt-6 u-mt-8@md u-mb-4 u-mb-6@md">
							
								<p class="c-logo u-mb-1">
									AEVI AppFlow
								</p><!-- /.c-logo -->
							
							
								<p>Copyright &copy;2019. - AEVI International GmbH <br>All rights reserved.</p>
							
						</div><!-- /.o-col -->
					</div><!-- /.o-row -->
				</div><!-- /.o-container -->
			</footer><!-- /.c-footer -->
		

		<script type="text/javascript" src="/pos-android-sdk/dox-theme/assets/js/vendor/jquery-3.3.1.min.js"></script>
		<script type="text/javascript" src="/pos-android-sdk/dox-theme/assets/js/scripts.min.js"></script>

		

	</body>
</html>

	

