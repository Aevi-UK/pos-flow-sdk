

<!DOCTYPE html>

	<html lang="en-GB">

	<head>
		<meta charset="UTF-8">
		<meta http-equiv="x-ua-compatible" content="ie=edge">
		<meta name="viewport" content="width=device-width, minimum-scale=1.0">
		
			<title>Implementing the services | AEVI AppFlow</title>
		
		
			<meta name="description" content="How to integrate any application with AppFlow to add data or augment the flow">
		
		
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono|IBM+Plex+Sans:400,400i,500,500i,700,700i">
		<link rel="stylesheet" href="/pos-android-sdk/dox-theme/assets/css/style.css">
		<link rel="icon" href="/pos-android-sdk/icon_large.png" sizes="32x32">
		<link rel="icon" href="/pos-android-sdk/icon_large.png" sizes="192x192">
		<link rel="apple-touch-icon-precomposed" href="/pos-android-sdk/icon_large.png">
		<meta name="msapplication-TileImage" content="/pos-android-sdk/icon_large.png">
	</head>
	<body>
		
			<div class="c-offcanvas">
				<div class="c-offcanvas__inner">
					
						<ul class="c-nav c-nav--stacked u-mx-auto">
							
								<li><a href="/pos-android-sdk/intro">Introduction</a></li>
							
								<li><a href="/pos-android-sdk/explore">Explore</a></li>
							
								<li><a href="/pos-android-sdk/downloads">Downloads</a></li>
							
								<li><a href="/pos-android-sdk/support">Support</a></li>
							
						</ul><!-- /.c-nav -->
					
					
						
							<a href="/reference" class="c-btn c-btn--md c-btn--gray u-text-md">
								Reference
								<div class="c-btn__icon">
									<i class="o-icon o-icon--folder"></i>
								</div>
							</a>
						
					
				</div><!-- /.c-offcanvas__inner -->
			</div><!-- /.c-offcanvas -->
		

		
			<header class="c-header">
				<div class="o-container">
					<div class="o-row">
						<div class="o-col-12">
							<div class="u-flex u-items-center">
								
									<div class="c-logo">
										<a href="/pos-android-sdk/" class="c-logo__link">
											<img src="/pos-android-sdk/aevi_logo.svg">
										</a><!-- /.c-logo__link -->
									</div><!-- /.c-logo -->
								
								
									<div class="u-flex u-items-center u-ml-auto">
										
											<ul class="c-nav u-mb-0 u-hidden u-block@lg">
												
													
													<li class=""><a href="/pos-android-sdk/intro">Introduction</a></li>
												
													
													<li class=""><a href="/pos-android-sdk/explore">Explore</a></li>
												
													
													<li class=""><a href="/pos-android-sdk/downloads">Downloads</a></li>
												
													
													<li class=""><a href="/pos-android-sdk/support">Support</a></li>
												
											</ul><!-- /.c-nav -->
										
										
											<div class="u-ml-5 u-hidden u-block@lg">
												
													<a href="/pos-android-sdk/reference" class="c-btn c-btn--md c-btn--gray u-text-md">
														Reference
														<div class="c-btn__icon">
															<i class="o-icon o-icon--folder"></i>
														</div>
													</a>
												
											</div>
										
									</div>
								
								<button class="c-hamburger-icon c-hamburger-icon--slider js-hamburger-icon js-offcanvas-toggle u-ml-auto u-hidden@lg" type="button">
									<span class="c-hamburger-icon__box">
										<span class="c-hamburger-icon__inner"></span>
									</span><!-- /.c-hamburger-icon__box -->
								</button><!-- /.c-hamburger-icon -->
							</div>
						</div><!-- /.o-col -->
					</div><!-- /.o-row -->
				</div><!-- /.o-container -->
			</header><!-- /.c-header -->
		







	
		<div class="c-hero u-bg-gray-30 u-pt-16 u-pb-10">
	
		<div class="o-container">
			<div class="o-row">
				<div class="o-col-10@lg o-col-9@xl">
					
						<h2 class="u-text-lg u-text-xl@sm">Value Added Services</h2>
					
					
						<div class="u-h6">
							<p>Implementing the services</p>
						</div>
					
					
					
				</div><!-- /.o-col -->
			</div><!-- /.o-row -->
		</div><!-- /.o-container -->
	</div>






	<div class="u-pt-8 u-pb-5">
		<div class="o-container">
			<div class="o-row">
				
					<div class="o-col-8@lg o-col-7@xl">
						<div class="c-post u-mb-3@lg js-post">
							<h1 id="implementing-the-services">Implementing the services</h1>

<p>Now that you have decided what stages are relevant for your application and set up the content provider, it is time to implement the actual service.
The service (which is an Android Service) is what FPS will be calling into for passing flow data and how your application can send back a response.</p>

<h2 id="defining-the-service-entry-point">Defining the service entry point</h2>

<p>Depending on the structure and requirements of your application, there are different approaches to defining your entry points for your service to be called.</p>

<p>There are two main options;</p>
<ul>
  <li>Extend a base service class and have full control over if/when UI is launched and how to handle events, etc</li>
  <li>Use a pre-defined service that simply proxies any request straight to an activity of your choice</li>
</ul>

<p>As as simple rule - if all your AppFlow implementation will be UI-based, then <code class="highlighter-rouge">ActivityProxyService</code> is the best place to start.
If on the other hand you have scenarios where you don’t require user interface, or need to execute asynchronously, extending <code class="highlighter-rouge">BasePaymentFlowService</code> gives you more flexibility.</p>

<p>You will see that each method has a <em>model</em> passed to it as a parameter. This is covered in detail on the next page.</p>

<h3 id="extending-basepaymentflowservice">Extending BasePaymentFlowService</h3>
<p>The <code class="highlighter-rouge">BasePaymentFlowService</code> contains a method per stage that a subclass can override to handle that particular stage.</p>

<p>An example of such a method is,</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPreFlow</span><span class="o">(</span><span class="n">PreFlowModel</span> <span class="n">model</span><span class="o">)</span> <span class="o">{}</span>
</code></pre></div></div>

<p>Here is an example of an implementation of this from the <a href="https://github.com/AEVI-AppFlow/pos-android-sdk/blob/master/PaymentServiceSample/src/main/java/com/aevi/sdk/pos/flow/paymentservicesample/service/PaymentService.java#L29"><code class="highlighter-rouge">Payment Service Sample</code></a>. It illustrates how some stages can be delegated to activities, and others to be handled from the service context itself.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaymentService</span> <span class="kd">extends</span> <span class="n">BasePaymentFlowService</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPaymentCardReading</span><span class="o">(</span><span class="n">CardReadingModel</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">model</span><span class="o">.</span><span class="na">processInActivity</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">PaymentCardReadingActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onTransactionProcessing</span><span class="o">(</span><span class="n">TransactionProcessingModel</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">model</span><span class="o">.</span><span class="na">processInActivity</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">TransactionProcessingActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onGeneric</span><span class="o">(</span><span class="n">GenericStageModel</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">GenericStageHandler</span><span class="o">.</span><span class="na">handleGenericRequest</span><span class="o">(</span><span class="n">model</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>This is defined in the <a href="https://github.com/AEVI-AppFlow/pos-android-sdk/blob/master/PaymentServiceSample/src/main/AndroidManifest.xml#L18">manifest</a> as follow,</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;service</span>
    <span class="na">android:name=</span><span class="s">".service.PaymentService"</span>
    <span class="na">android:exported=</span><span class="s">"true"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;intent-filter&gt;</span>
        <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">"com.aevi.sdk.flow.action.PROCESS_GENERIC"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">"com.aevi.sdk.flow.action.READ_PAYMENT_CARD"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">"com.aevi.sdk.flow.action.PROCESS_TRANSACTION"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/intent-filter&gt;</span>
<span class="nt">&lt;/service&gt;</span>
</code></pre></div></div>

<p>In order for your application to be called at a specific stage it must expose the appropriate action intent-filter as shown above. <a href="https://github.com/AEVI-AppFlow/pos-android-sdk/blob/release/2.1.0/flow-base-api/src/main/java/com/aevi/sdk/flow/constants/IntentActions.java">A full list of these can be found here</a></p>

<h3 id="using-activityproxyservice">Using ActivityProxyService</h3>
<p><code class="highlighter-rouge">ActivityProxyService</code> is a service defined in the API that can be used to proxy through any request to an activity. This is useful if all your requests handling requires user interaction, as you can avoid setting up pure boilerplate services just to start activities.</p>

<p>The service is defined in the manifest as follows, where you choose which stages you want to handle via the intent actions. The example below is set up for <code class="highlighter-rouge">PRE_FLOW</code> only.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;service</span>
    <span class="na">android:name=</span><span class="s">"com.aevi.sdk.pos.flow.service.ActivityProxyService"</span>
    <span class="na">android:exported=</span><span class="s">"true"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;intent-filter&gt;</span>
        <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">"com.aevi.sdk.flow.action.PROCESS_PRE_FLOW"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/intent-filter&gt;</span>
<span class="nt">&lt;/service&gt;</span>
</code></pre></div></div>

<p>You then need to define an activity for each stage you want the requests proxied to, as per below for PRE_FLOW. Pay attention to the intent action.</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;activity</span>
    <span class="na">android:name=</span><span class="s">".ui.PreFlowActivity"</span>
    <span class="na">android:excludeFromRecents=</span><span class="s">"true"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;intent-filter&gt;</span>
        <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">"com.aevi.sdk.flow.action.PROCESS_PRE_FLOW_IN_ACTIVITY"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/intent-filter&gt;</span>
<span class="nt">&lt;/activity&gt;</span>
</code></pre></div></div>

<p>The way the <code class="highlighter-rouge">ActivityProxyService</code> looks up what activity to delegate to is via the stage name. It will build the intent action as follows,
<code class="highlighter-rouge">intentAction = "com.aevi.sdk.flow.action.PROCESS_" + stageName + "_IN_ACTIVITY"</code>.</p>

<p>Once your activity is created (via <code class="highlighter-rouge">onCreate()</code>, you can then initialise the stage model from the static <code class="highlighter-rouge">fromActivity()</code> method, as per below for <code class="highlighter-rouge">PRE_FLOW</code>;</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
    <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_pre_flow</span><span class="o">);</span>
    <span class="n">PreFlowModel</span> <span class="n">preFlowModel</span> <span class="o">=</span> <span class="n">PreFlowModel</span><span class="o">.</span><span class="na">fromActivity</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The models only keep a weak reference to your activities, so there are no risks of activity memory leaks via the models even if your code passes these onto other classes in your application.</p>

<div class="callout callout--info">
  <p>Note - make sure to read about flow service events further down this page to understand how using the proxy impacts this.</p>
</div>

<h2 id="handling-status-updates">Handling status updates</h2>

<p><a href="/pos-android-sdk/guides/pos/status-update-flows">Status update flows</a> are a bit different to the other flows in that they are processed in the <em>background</em> and requests are submitted to a <em>request queue</em>. They can be processed in parallel to the standard payment and generic flows.</p>

<p>To handle these updates, either extend the <code class="highlighter-rouge">BaseStatusUpdateService</code> or override <code class="highlighter-rouge">onStatusUpdate()</code> method in a <code class="highlighter-rouge">BasePaymentFlowService</code> implementation.
Applications can choose to finish without passing back any data to the client via the <code class="highlighter-rouge">finish()</code> method in the model, or pass back a set of references via the <code class="highlighter-rouge">finishWithReferences()</code> method.</p>

<div class="callout callout--warning">
  <p>Applications that process status updates must ONLY run in the background - i.e handle the update in the service and not launch any activities. The proxy approach may not be used for this.</p>
</div>

<h2 id="stages-summary">Stages summary</h2>

<table>
  <thead>
    <tr>
      <th>Stage</th>
      <th>Intent Action</th>
      <th>Stage model</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">PRE_FLOW</code></td>
      <td><code class="highlighter-rouge">com.aevi.sdk.flow.action.PROCESS_PRE_FLOW</code></td>
      <td><code class="highlighter-rouge">PreFlowModel</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">SPLIT</code></td>
      <td><code class="highlighter-rouge">com.aevi.sdk.flow.action.PROCESS_SPLIT</code></td>
      <td><code class="highlighter-rouge">SplitModel</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">PRE_TRANSACTION</code></td>
      <td><code class="highlighter-rouge">com.aevi.sdk.flow.action.PROCESS_PRE_TRANSACTION</code></td>
      <td><code class="highlighter-rouge">PreTransactionModel</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">POST_CARD_READING</code></td>
      <td><code class="highlighter-rouge">com.aevi.sdk.flow.action.PROCESS_POST_CARD_READING</code></td>
      <td><code class="highlighter-rouge">PreTransactionModel</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">POST_TRANSACTION</code></td>
      <td><code class="highlighter-rouge">com.aevi.sdk.flow.action.PROCESS_POST_TRANSACTION</code></td>
      <td><code class="highlighter-rouge">PostTransactionModel</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">POST_FLOW</code></td>
      <td><code class="highlighter-rouge">com.aevi.sdk.flow.action.PROCESS_POST_FLOW</code></td>
      <td><code class="highlighter-rouge">PostFlowModel</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">GENERIC</code></td>
      <td><code class="highlighter-rouge">com.aevi.sdk.flow.action.PROCESS_GENERIC</code></td>
      <td><code class="highlighter-rouge">GenericModel</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">POST_GENERIC</code></td>
      <td><code class="highlighter-rouge">com.aevi.sdk.flow.action.PROCESS_POST_GENERIC</code></td>
      <td><code class="highlighter-rouge">PostGenericModel</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">STATUS_UPDATE</code></td>
      <td><code class="highlighter-rouge">com.aevi.sdk.flow.action.PROCESS_STATUS_UPDATE</code></td>
      <td><code class="highlighter-rouge">StatusUpdateModel</code></td>
    </tr>
  </tbody>
</table>

<h2 id="asynchronous-request-handling">Asynchronous request handling</h2>
<p>A flow service can handle a request asynchronously in a fire-and-forget fashion where FPS does not wait for any response. This is mainly useful for the “post” stages where there may be apps that are interested in the outcome of things (such as for analytics), but do not want to provide any input back or delay the processing completion.</p>

<p>Any flow service can do this via simply returning back an empty response immediately from the model (finish(), skip(), etc) and then continuing to execute. It is up to each flow service if and when the service is stopped as described in a section below.</p>

<p><strong>Note</strong> that this is only allowed from a <em>service</em>, you may not keep any activities running after sending response or skip.</p>

<h2 id="service-lifecycle">Service lifecycle</h2>
<p>AppFlow does not ever stop your service. It is entirely up to your implementation if the service should remain running in the background (until Android kills it) and accepts requests, or shut down after each request has been handled via a call to <code class="highlighter-rouge">stopSelf()</code>.</p>

<p>You can also call <code class="highlighter-rouge">setStopServiceOnEndOfStream(true)</code> from the service to indicate that you want the service to automatically be stopped after the client (FPS) has closed the connection.</p>

<p>Do note however that if you wish to process data in the background / asynchronously to the flow (via passing back an empty response and continuing parsing the input data - typically for analytics, etc), you need to ensure you don’t call the above method or <code class="highlighter-rouge">stopSelf()</code> too early.</p>

							

						</div><!-- /.c-post -->
					</div><!-- /.o-col -->
				
				
					<div class="o-col-3@lg o-offset-1@lg o-offset-2@xl">
						<ul class="c-page-nav u-sticky u-pin-t-6 u-mt-4 u-mt-1@lg u-mb-1 u-mb-4@lg">
							
							
							
								
								
									
										<li>
											<a href="/pos-android-sdk/guides/vaa/pre-requisites">
												<p class="c-page-nav__heading">Pre-requisites</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li>
											<a href="/pos-android-sdk/guides/vaa/api-overview">
												<p class="c-page-nav__heading">API Overview</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li>
											<a href="/pos-android-sdk/guides/vaa/determine-stages">
												<p class="c-page-nav__heading">Determine flow stages</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li>
											<a href="/pos-android-sdk/guides/vaa/expose-app-info">
												<p class="c-page-nav__heading">Expose app info</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li>
											<a href="/pos-android-sdk/guides/vaa/implementing-flow-services">
												<p class="c-page-nav__heading">Implementing the services</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li class="is-active">
											<a href="/pos-android-sdk/guides/vaa/interacting-stage-models">
												<p class="c-page-nav__heading">Interacting with stage models</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li class="is-active">
											<a href="/pos-android-sdk/guides/vaa/handling-events">
												<p class="c-page-nav__heading">Handling events</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li class="is-active">
											<a href="/pos-android-sdk/guides/vaa/flow-response-listeners">
												<p class="c-page-nav__heading">Adding response listeners</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li class="is-active">
											<a href="/pos-android-sdk/guides/vaa/application-guidelines">
												<p class="c-page-nav__heading">Application Guidelines</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li class="is-active">
											<a href="/pos-android-sdk/guides/vaa/next-steps">
												<p class="c-page-nav__heading">Next steps</p>
											</a>
										</li>
									
									
								
							
						</ul><!-- /.c-page-nav -->
					</div><!-- /.o-col -->
				
			</div><!-- /.o-row -->
		</div><!-- /.o-container -->
	</div>



	
	
		<div class="u-bg-primary u-text-white u-pt-3 u-pt-4@sm u-pb-3 u-pb-4@sm">
			<div class="o-container">
				<div class="o-row">
					<div class="o-col-12 u-text-center">
						<div class="u-inline-block u-flex@sm">
							
							
							 	
							
							 	
							
							 	
							
							 	
							
							 	
								  
									
									
									
									
										<a href="/pos-android-sdk/guides/vaa/expose-app-info" class="c-arrow-link c-arrow-link--prev u-mr-auto">Expose app info</a>
									
									
										<a href="/pos-android-sdk/guides/vaa/interacting-stage-models" class="c-arrow-link c-arrow-link--next u-ml-auto">Interacting with stage models</a>
									
								
							
							 	
							
							 	
							
							 	
							
							 	
							
							 	
							
						</div>
					</div><!-- /.o-col -->
				</div><!-- /.o-row -->
			</div><!-- /.o-container -->
		</div>
		

		
			<footer class="c-footer">
				<div class="o-container">
					<div class="o-row">
						<div class="o-col-12 u-mt-6 u-mt-8@md u-mb-4 u-mb-6@md">
							
								<p class="c-logo u-mb-1">
									AEVI AppFlow
								</p><!-- /.c-logo -->
							
							
								<p>Copyright &copy;2019. - AEVI International GmbH <br>All rights reserved.</p>
							
						</div><!-- /.o-col -->
					</div><!-- /.o-row -->
				</div><!-- /.o-container -->
			</footer><!-- /.c-footer -->
		

		<script type="text/javascript" src="/pos-android-sdk/dox-theme/assets/js/vendor/jquery-3.3.1.min.js"></script>
		<script type="text/javascript" src="/pos-android-sdk/dox-theme/assets/js/scripts.min.js"></script>

		

	</body>
</html>

	

