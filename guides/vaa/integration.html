

<!DOCTYPE html>

	<html lang="en-GB">

	<head>
		<meta charset="UTF-8">
		<meta http-equiv="x-ua-compatible" content="ie=edge">
		<meta name="viewport" content="width=device-width, minimum-scale=1.0">
		
			<title>Integration | AEVI AppFlow</title>
		
		
			<meta name="description" content="How to integrate any application with AppFlow to add data or augment the flow">
		
		
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono|IBM+Plex+Sans:400,400i,500,500i,700,700i">
		<link rel="stylesheet" href="/pos-android-sdk/dox-theme/assets/css/style.css">
		<link rel="icon" href="/pos-android-sdk/icon_large.png" sizes="32x32">
		<link rel="icon" href="/pos-android-sdk/icon_large.png" sizes="192x192">
		<link rel="apple-touch-icon-precomposed" href="/pos-android-sdk/icon_large.png">
		<meta name="msapplication-TileImage" content="/pos-android-sdk/icon_large.png">
	</head>
	<body>
		
			<div class="c-offcanvas">
				<div class="c-offcanvas__inner">
					
						<ul class="c-nav c-nav--stacked u-mx-auto">
							
								<li><a href="/pos-android-sdk/appflow-overview">Overview</a></li>
							
								<li><a href="/pos-android-sdk/guides">Guides</a></li>
							
								<li><a href="/pos-android-sdk/technical">Technical Docs</a></li>
							
						</ul><!-- /.c-nav -->
					
					
						
							<a href="/technical/javadocs" class="c-btn c-btn--md c-btn--gray u-text-md">
								Reference
								<div class="c-btn__icon">
									<i class="o-icon o-icon--folder"></i>
								</div>
							</a>
						
					
				</div><!-- /.c-offcanvas__inner -->
			</div><!-- /.c-offcanvas -->
		

		
			<header class="c-header">
				<div class="o-container">
					<div class="o-row">
						<div class="o-col-12">
							<div class="u-flex u-items-center">
								
									<div class="c-logo">
										<a href="/pos-android-sdk/" class="c-logo__link">
											<img src="/pos-android-sdk/aevi_logo.svg">
										</a><!-- /.c-logo__link -->
									</div><!-- /.c-logo -->
								
								
									<div class="u-flex u-items-center u-ml-auto">
										
											<ul class="c-nav u-mb-0 u-hidden u-block@lg">
												
													
													<li class=""><a href="/pos-android-sdk/appflow-overview">Overview</a></li>
												
													
													<li class=""><a href="/pos-android-sdk/guides">Guides</a></li>
												
													
													<li class=""><a href="/pos-android-sdk/technical">Technical Docs</a></li>
												
											</ul><!-- /.c-nav -->
										
										
											<div class="u-ml-5 u-hidden u-block@lg">
												
													<a href="/pos-android-sdk/technical/javadocs" class="c-btn c-btn--md c-btn--gray u-text-md">
														Reference
														<div class="c-btn__icon">
															<i class="o-icon o-icon--folder"></i>
														</div>
													</a>
												
											</div>
										
									</div>
								
								<button class="c-hamburger-icon c-hamburger-icon--slider js-hamburger-icon js-offcanvas-toggle u-ml-auto u-hidden@lg" type="button">
									<span class="c-hamburger-icon__box">
										<span class="c-hamburger-icon__inner"></span>
									</span><!-- /.c-hamburger-icon__box -->
								</button><!-- /.c-hamburger-icon -->
							</div>
						</div><!-- /.o-col -->
					</div><!-- /.o-row -->
				</div><!-- /.o-container -->
			</header><!-- /.c-header -->
		







	
		<div class="c-hero u-bg-gray-30 u-pt-16 u-pb-10">
	
		<div class="o-container">
			<div class="o-row">
				<div class="o-col-10@lg o-col-9@xl">
					
						<h2 class="u-text-lg u-text-xl@sm">Integrating Value Added Applications</h2>
					
					
						<div class="u-h6">
							<p>How to integrate any application with AppFlow to add value to the flow</p>
						</div>
					
					
					
				</div><!-- /.o-col -->
			</div><!-- /.o-row -->
		</div><!-- /.o-container -->
	</div>






	<div class="u-pt-8 u-pb-5">
		<div class="o-container">
			<div class="o-row">
				
					<div class="o-col-8@lg o-col-7@xl">
						<div class="c-post u-mb-3@lg js-post">
							<h1 id="integrating-your-application">Integrating your application</h1>

<p>The information below shows you how to implement the appropriate service(s) and/or activities for the stages your application supports and how to expose them so that FPS can find them during application scanning.</p>

<h2 id="adding-the-service-info-provider">Adding the service info provider</h2>

<p>In order for FPS and client applications to know what your service supports, you need to implement a content provider that returns relevant information about your service.</p>

<p>This is done by extending <code class="highlighter-rouge">BasePaymentFlowServiceInfoProvider</code>, as the sample code from the <code class="highlighter-rouge">Flow Service Sample</code> below shows</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaymentFlowServiceInfoProvider</span> <span class="kd">extends</span> <span class="n">BasePaymentFlowServiceInfoProvider</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="n">PaymentFlowServiceInfo</span> <span class="n">getPaymentFlowServiceInfo</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">PaymentFlowServiceInfoBuilder</span><span class="o">()</span>
      <span class="o">.</span><span class="na">withVendor</span><span class="o">(</span><span class="s">"AEVI"</span><span class="o">)</span>
      <span class="o">.</span><span class="na">withDisplayName</span><span class="o">(</span><span class="s">"Flow Service Sample"</span><span class="o">)</span>
      <span class="o">.</span><span class="na">withCanAdjustAmounts</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
      <span class="o">.</span><span class="na">withCanPayAmounts</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="n">PaymentMethods</span><span class="o">.</span><span class="na">LOYALTY_POINTS</span><span class="o">,</span> <span class="n">PaymentMethods</span><span class="o">.</span><span class="na">GIFT_CARD</span><span class="o">,</span> <span class="n">PaymentMethods</span><span class="o">.</span><span class="na">CASH</span><span class="o">)</span>
      <span class="o">.</span><span class="na">withSupportedFlowTypes</span><span class="o">(</span><span class="n">FlowTypes</span><span class="o">.</span><span class="na">SALE</span><span class="o">)</span>
      <span class="o">.</span><span class="na">withCustomRequestTypes</span><span class="o">(</span><span class="n">ShowLoyaltyPointsBalanceService</span><span class="o">.</span><span class="na">SHOW_LOYALTY_POINTS_REQUEST</span><span class="o">)</span>
      <span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">getContext</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>

</code></pre>
</div>

<p>The following fields are mandatory for value added flow services</p>

<ul>
  <li>Vendor</li>
  <li>Display name</li>
  <li>withCanPayAmounts() - If you provide any form of payment method or apply discounts to baskets</li>
  <li>withCanAdjustAmounts() - If you add amounts, like tip, fees, charity, tax, etc</li>
</ul>

<p>Note that if you fail to report that your service can pay or adjust amounts here, FPS will reject any attempts from your application to do so.</p>

<p><code class="highlighter-rouge">withSupportedFlowTypes()</code> is optional - if left empty, it means FPS will call your flow service for any type and its up to your flow service to handle unsupported types. If types are specified, FPS will ensure your service only gets called for flows with types that your service supports. See <a href="/pos-android-sdk/technical/request-types">Request Types</a> for defined types.</p>

<p>In addition, <code class="highlighter-rouge">withCustomRequestTypes()</code> can be used to define custom types that are specific to your flow service. This may be a function to return some particular data like loyalty balance, or to display such data. It is entirely up to your application what data is required and returned and whether your service shows any UI for it or not. In order for other applications to know about this type however, it needs to be advertised. See <a href="/pos-android-sdk/technical/bespoke-data">Bespoke Data</a> for details.</p>

<p>The provider then needs to be exposed in the application manifest.</p>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;provider</span>
  <span class="na">android:name=</span><span class="s">".PaymentFlowServiceInfoProvider"</span>
  <span class="na">android:authorities=</span><span class="s">"&lt;your authority&gt;"</span>
  <span class="na">android:exported=</span><span class="s">"true"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;intent-filter&gt;</span>
      <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">"com.aevi.sdk.flow.action.PROVIDE_SERVICE_INFO"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/intent-filter&gt;</span>
<span class="nt">&lt;/provider&gt;</span>
</code></pre>
</div>

<h2 id="relevant-flow-stages">Relevant flow stages</h2>
<p>The following payment stages, as described in the general API intro, are relevant for value added services</p>

<ul>
  <li><code class="highlighter-rouge">SPLIT</code></li>
  <li><code class="highlighter-rouge">PRE_TRANSACTION</code></li>
  <li><code class="highlighter-rouge">POST_CARD_READING</code></li>
  <li><code class="highlighter-rouge">POST_TRANSACTION</code></li>
  <li><code class="highlighter-rouge">POST_FLOW</code> (maybe)</li>
</ul>

<p>In addition, if your application will be defining custom request types, you will need to handle the <code class="highlighter-rouge">GENERIC</code> stage.</p>

<p>If you are interested in your application being called after another application has handled a generic request, like <code class="highlighter-rouge">tokenisation</code>, you should support the <code class="highlighter-rouge">POST_GENERIC</code> stage. Note that you do not (should not) list supported flow types for <code class="highlighter-rouge">POST_GENERIC</code> applications - they will be called for all types.</p>

<p>The next sections will cover what can be done in what stages, and go over some common use cases.</p>

<h2 id="augmentation-details">Augmentation details</h2>
<p>Depending on what function your application is offering and for what stages it will be called, there are different augmentation options. This section will break down all the augmentation options (for payment flows specifically) and for what stages and functions they may be useful. The next section will look at specific use cases and advise on how to model your service for that use case.</p>

<h3 id="pre-transaction-processing-augmentations">Pre transaction-processing augmentations</h3>
<p>The majority of the relevant augmentations happen before the <code class="highlighter-rouge">TRANSACTION_PROCESSING</code> stage where a payment service determines the outcome of the transaction. After that point, all flow services can do is add references. This section will cover the augmentation options for the <code class="highlighter-rouge">PRE_TRANSACTION</code> and <code class="highlighter-rouge">POST_CARD_READING</code> stages. For both these stages, any augmentations are done via the <code class="highlighter-rouge">PreTransactionModel</code>.</p>

<div class="callout callout--warning">
  <p>Note that `PRE_FLOW` is not covered here as it's intended for quite specific use cases.</p>
</div>

<h4 id="adding-additional-amounts">Adding additional amounts</h4>
<p>There are various scenarios for which adding additional amounts is relevant, be it for tipping, fees, donations, etc. The <code class="highlighter-rouge">PreTransactionModel</code> contains two methods for doing this;</p>
<ul>
  <li><code class="highlighter-rouge">setAdditionalAmount(String identifier, long amount)</code></li>
  <li><code class="highlighter-rouge">setAdditionalAmountAsBaseFraction(String identifier, float fraction)</code></li>
</ul>

<p>The first method allows you to specify the amount value in its sub-unit form, whereas the second method allows you to add an amount as a <em>fraction</em> of the request <em>base amount value</em>. This is useful for a variety of cases where the amount is a percentage of the base amount, such as fees, tipping, etc.</p>

<p>In both cases, the amount is identified via a string identifier. See <a href="/pos-android-sdk/technical/additional-amounts">Additional Amounts</a> for details.</p>

<h4 id="adding-a-basket">Adding a basket</h4>
<p>The client/POS application may have provided a basket in the initial request. To provide sensible separation between what app/service added what items, flow services can add <em>new</em> baskets, but not add more items to the existing baskets (discounts excepted). This can be done with the <code class="highlighter-rouge">PreTransactionModel.addNewBasket(Basket basket)</code> method.</p>

<p>This is the recommended approach to add any form of “upsells” or extras, as it adds visibility of what specifically has been added, allowing receipts apps to show it clearly on the receipts.</p>

<div class="callout callout--warning">
  <p>Note that the request amounts will be automatically updated to reflect this new basket.</p>
</div>

<h4 id="addingupdating-customer-details">Adding/updating customer details</h4>
<p>A flow service can either add or update customer details. If the initial <code class="highlighter-rouge">Payment</code> does not contain any customer data, the flow service can create a new <code class="highlighter-rouge">Customer</code> model and add to the transaction. If however a <code class="highlighter-rouge">Customer</code> model already exists, a flow service can add</p>
<ul>
  <li>Tokens</li>
  <li>Customer details as additional data</li>
</ul>

<p>Either case is done via <code class="highlighter-rouge">PreTransactionModel.addOrUpdateCustomerDetails(Customer customer)</code>. If adding, the <code class="highlighter-rouge">Customer</code> parameter is created by your service. If updating, you use the <code class="highlighter-rouge">Customer</code> model from the request, update it and then pass it in here.</p>

<h4 id="paying-amounts">Paying amounts</h4>
<p>A flow service can pay off a portion or all of the requested amounts. The most common scenario for this is via loyalty rewards or points. This can be done via <code class="highlighter-rouge">PreTransactionModel.setAmountsPaid(Amounts amountsPaid, String paymentMethod)</code>. The amounts must not exceed requested amounts and the payment method must be set. See <a href="/pos-android-sdk/technical/payment-methods">Payment Methods</a> for defined options.</p>

<p>This method is recommended when the payment has no relation to any basket items. If however the payment is provided as discounts to certain items in the basket, like offering a free coffee, then the recommended approach is to apply discounts to baskets which is covered in the next section.</p>

<h4 id="applying-discounts-to-baskets">Applying discounts to baskets</h4>
<p>If your service provides discounts or rewards based on basket items, then this function will allow your service to apply discounts as items in the same basket. As an example, if the basket contains an item “Latte” with a cost of $3.50, you can via this method add a “free coffee reward” that would look something like “Reward: Free Latte” with a negative amount of $-3.50 to negate the cost of the original item.</p>

<p>See <code class="highlighter-rouge">PreTransactionModel.applyDiscountsToBasket(String basketId, List&lt;BasketItem&gt; basketItems, String paymentMethod)</code> for more info.</p>

<h4 id="adding-request-data">Adding request data</h4>
<p>Any arbitrary data that may be required or useful for other flow services (or the POS app) can be added via the <code class="highlighter-rouge">PreTransactionModel.addRequestData(String key, T... values)</code> method.</p>

<h3 id="adding-references-after-transaction-processing">Adding references after transaction processing</h3>
<p>The <code class="highlighter-rouge">PostTransactionModel</code> offers a <code class="highlighter-rouge">addReferences(String key, T... values)</code> method to provide references back to the POS app for the transaction.</p>

<h2 id="sending-response">Sending response</h2>
<p>Once your service has completed all its augmentation of the flow it should respond to FPS. Responses can be sent once you have finished augmenting data in the stage model via the <code class="highlighter-rouge">sendResponse()</code> method.</p>

<div class="callout callout--warning">
  <p>Even if you DO NOT augment the data in any way then your service must still call one of the <code>sendResponse()</code> / <code>skip()</code> / <code>finish()</code> methods to tell FPS that your service is done.</p>
</div>

							

						</div><!-- /.c-post -->
					</div><!-- /.o-col -->
				
				
					<div class="o-col-3@lg o-offset-1@lg o-offset-2@xl">
						<ul class="c-page-nav u-sticky u-pin-t-6 u-mt-4 u-mt-1@lg u-mb-1 u-mb-4@lg">
							
							
							
								
								
									
										<li class="is-active">
											<a href="/pos-android-sdk/guides/vaa/pre-requisites">
												<p class="c-page-nav__heading">Pre-requisites</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li class="is-active">
											<a href="/pos-android-sdk/guides/vaa/implementing-flow-services">
												<p class="c-page-nav__heading">Implementing Flow Services</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li class="is-active">
											<a href="/pos-android-sdk/guides/vaa/integration">
												<p class="c-page-nav__heading">Integration</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li>
											<a href="/pos-android-sdk/guides/vaa/flow-response-listeners">
												<p class="c-page-nav__heading">Flow response listener</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li>
											<a href="/pos-android-sdk/guides/vaa/application-guidelines">
												<p class="c-page-nav__heading">Application Guidelines</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li>
											<a href="/pos-android-sdk/guides/vaa/use-cases">
												<p class="c-page-nav__heading">Use cases</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li>
											<a href="/pos-android-sdk/guides/vaa/receipt-considerations">
												<p class="c-page-nav__heading">Receipt Applications</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li>
											<a href="/pos-android-sdk/guides/vaa/split-considerations">
												<p class="c-page-nav__heading">Split Applications</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li>
											<a href="/pos-android-sdk/guides/vaa/dealing-with-amounts">
												<p class="c-page-nav__heading">Dealing with Amounts</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li>
											<a href="/pos-android-sdk/guides/vaa/initiating-a-flow">
												<p class="c-page-nav__heading">Initiating a flow</p>
											</a>
										</li>
									
									
								
							
								
								
									
										<li>
											<a href="/pos-android-sdk/guides/vaa/references">
												<p class="c-page-nav__heading">References</p>
											</a>
										</li>
									
									
								
							
						</ul><!-- /.c-page-nav -->
					</div><!-- /.o-col -->
				
			</div><!-- /.o-row -->
		</div><!-- /.o-container -->
	</div>



	
	
		<div class="u-bg-primary u-text-white u-pt-3 u-pt-4@sm u-pb-3 u-pb-4@sm">
			<div class="o-container">
				<div class="o-row">
					<div class="o-col-12 u-text-center">
						<div class="u-inline-block u-flex@sm">
							
							
							 	
							
							 	
							
							 	
								  
									
									
									
									
										<a href="/pos-android-sdk/guides/vaa/implementing-flow-services" class="c-arrow-link c-arrow-link--prev u-mr-auto">Implementing Flow Services</a>
									
									
										<a href="/pos-android-sdk/guides/vaa/flow-response-listeners" class="c-arrow-link c-arrow-link--next u-ml-auto">Flow response listener</a>
									
								
							
							 	
							
							 	
							
							 	
							
							 	
							
							 	
							
							 	
							
							 	
							
							 	
							
						</div>
					</div><!-- /.o-col -->
				</div><!-- /.o-row -->
			</div><!-- /.o-container -->
		</div>
		

		
			<footer class="c-footer">
				<div class="o-container">
					<div class="o-row">
						<div class="o-col-12 u-mt-6 u-mt-8@md u-mb-4 u-mb-6@md">
							
								<p class="c-logo u-mb-1">
									AEVI AppFlow
								</p><!-- /.c-logo -->
							
							
								<p>Copyright &copy;2019. - AEVI International GmbH <br>All rights reserved.</p>
							
						</div><!-- /.o-col -->
					</div><!-- /.o-row -->
				</div><!-- /.o-container -->
			</footer><!-- /.c-footer -->
		

		<script type="text/javascript" src="/pos-android-sdk/dox-theme/assets/js/vendor/jquery-3.3.1.min.js"></script>
		<script type="text/javascript" src="/pos-android-sdk/dox-theme/assets/js/scripts.min.js"></script>

		

	</body>
</html>

	

