

<!DOCTYPE html>

	<html lang="en-GB">

	<head>
		<meta charset="UTF-8">
		<meta http-equiv="x-ua-compatible" content="ie=edge">
		<meta name="viewport" content="width=device-width, minimum-scale=1.0">
		
			<title>Legacy Conversion | AEVI AppFlow</title>
		
		
		
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono|IBM+Plex+Sans:400,400i,500,500i,700,700i">
		<link rel="stylesheet" href="/pos-android-sdk/dox-theme/assets/css/style.css">
		<link rel="icon" href="/pos-android-sdk/icon_large.png" sizes="32x32">
		<link rel="icon" href="/pos-android-sdk/icon_large.png" sizes="192x192">
		<link rel="apple-touch-icon-precomposed" href="/pos-android-sdk/icon_large.png">
		<meta name="msapplication-TileImage" content="/pos-android-sdk/icon_large.png">
	</head>
	<body>
		
			<div class="c-offcanvas">
				<div class="c-offcanvas__inner">
					
						<ul class="c-nav c-nav--stacked u-mx-auto">
							
								<li><a href="/pos-android-sdk/appflow-overview">Overview</a></li>
							
								<li><a href="/pos-android-sdk/guides">Guides</a></li>
							
								<li><a href="/pos-android-sdk/technical">Technical Docs</a></li>
							
						</ul><!-- /.c-nav -->
					
					
						
							<a href="/technical/javadocs" class="c-btn c-btn--md c-btn--gray u-text-md">
								Reference
								<div class="c-btn__icon">
									<i class="o-icon o-icon--folder"></i>
								</div>
							</a>
						
					
				</div><!-- /.c-offcanvas__inner -->
			</div><!-- /.c-offcanvas -->
		

		
			<header class="c-header">
				<div class="o-container">
					<div class="o-row">
						<div class="o-col-12">
							<div class="u-flex u-items-center">
								
									<div class="c-logo">
										<a href="/pos-android-sdk/" class="c-logo__link">
											<img src="/pos-android-sdk/aevi_logo.svg">
										</a><!-- /.c-logo__link -->
									</div><!-- /.c-logo -->
								
								
									<div class="u-flex u-items-center u-ml-auto">
										
											<ul class="c-nav u-mb-0 u-hidden u-block@lg">
												
													
													<li class=""><a href="/pos-android-sdk/appflow-overview">Overview</a></li>
												
													
													<li class=""><a href="/pos-android-sdk/guides">Guides</a></li>
												
													
													<li class=""><a href="/pos-android-sdk/technical">Technical Docs</a></li>
												
											</ul><!-- /.c-nav -->
										
										
											<div class="u-ml-5 u-hidden u-block@lg">
												
													<a href="/pos-android-sdk/technical/javadocs" class="c-btn c-btn--md c-btn--gray u-text-md">
														Reference
														<div class="c-btn__icon">
															<i class="o-icon o-icon--folder"></i>
														</div>
													</a>
												
											</div>
										
									</div>
								
								<button class="c-hamburger-icon c-hamburger-icon--slider js-hamburger-icon js-offcanvas-toggle u-ml-auto u-hidden@lg" type="button">
									<span class="c-hamburger-icon__box">
										<span class="c-hamburger-icon__inner"></span>
									</span><!-- /.c-hamburger-icon__box -->
								</button><!-- /.c-hamburger-icon -->
							</div>
						</div><!-- /.o-col -->
					</div><!-- /.o-row -->
				</div><!-- /.o-container -->
			</header><!-- /.c-header -->
		


<div class="u-bg-gray-30 u-pt-8 u-pb-10">
</div>


		<div class="o-container">
			<div class="o-row">
				<div class="o-col-8@lg o-col-7@xl">
						<h2 class="u-text-lg u-text-xl@sm">Legacy Conversion</h2>
				</div>
			</div>
		</div>
		<div class="o-container">
			<div class="o-row">
				
					<div class="o-col-12@lg o-col-11@xl">
						<div class="c-post u-mb-3@lg js-post">
							<p>The POS Flow API is a completely new API provided by AEVI. It can be used on a single device at the same time as the original AEVI Public SDK if the applications installed on the device support it. However, there are times when you may be required to convert between calls to the new POS Flow API and the original v2 API. Usually this involves converting transaction references from one API to the other. The two scenarios to and from the v2 API are described here.</p>

<h2 id="conversion-of-references-from-legacy-api-to-appflow">Conversion of references from Legacy API to AppFlow</h2>

<p>For completion requests or other two stage financial transactions the transaction references of the previous request (pre-authorisation) that initiated the payment must be returned along with the request. For conversion between a previous v2 <code class="highlighter-rouge">TransactionResult</code> references and the new API you can make use of the following example.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Converter</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">AdditionalData</span> <span class="n">getAdditionalDataFromResultReferences</span><span class="o">(</span><span class="n">TransactionReferences</span> <span class="n">transactionReferences</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">AdditionalData</span> <span class="n">additionalData</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AdditionalData</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">TransactionReferenceCode</span> <span class="n">code</span> <span class="o">:</span> <span class="n">transactionReferences</span><span class="o">.</span><span class="na">getTransactionCodes</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">additionalData</span><span class="o">.</span><span class="na">addData</span><span class="o">(</span><span class="n">code</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">code</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">additionalData</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>POS Flow <code class="highlighter-rouge">preAuthCompletions</code> also require the amount to be specifically set. If you would like to obtain the amount directly from a previous<code class="highlighter-rouge">TransactionResult</code> the following code can be used to obtain it.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">static</span> <span class="n">Amounts</span> <span class="nf">getCompletionAmounts</span><span class="p">(</span><span class="n">TransactionResult</span> <span class="n">result</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">LegacyConversionException</span> <span class="o">{</span>
    <span class="n">TransactionReferences</span> <span class="n">references</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">getTransactionReferences</span><span class="o">();</span>
    <span class="n">String</span> <span class="n">currency</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">references</span><span class="o">.</span><span class="na">getTransactionReferenceCode</span><span class="o">(</span><span class="n">TransactionReferences</span><span class="o">.</span><span class="na">CURRENCY</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">currency</span> <span class="o">=</span> <span class="n">references</span><span class="o">.</span><span class="na">getTransactionReferenceCode</span><span class="o">(</span><span class="n">TransactionReferences</span><span class="o">.</span><span class="na">CURRENCY</span><span class="o">).</span><span class="na">getValue</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">currency</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"No currency reference available for completion request - erroring out"</span><span class="o">);</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">LegacyConversionException</span><span class="o">(</span><span class="n">CURRENCY_NOT_SUPPORTED</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">BigDecimal</span> <span class="n">amount</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">references</span><span class="o">.</span><span class="na">getTransactionReferenceCode</span><span class="o">(</span><span class="n">TransactionReferences</span><span class="o">.</span><span class="na">AMOUNT</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">amountStr</span> <span class="o">=</span> <span class="n">references</span><span class="o">.</span><span class="na">getTransactionReferenceCode</span><span class="o">(</span><span class="n">TransactionReferences</span><span class="o">.</span><span class="na">AMOUNT</span><span class="o">).</span><span class="na">getValue</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">amountStr</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="s">"[0-9]+"</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">amount</span> <span class="o">=</span> <span class="n">longToBigDecimal</span><span class="o">(</span><span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">amountStr</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">amountStr</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"."</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">amount</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BigDecimal</span><span class="o">(</span><span class="n">amountStr</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">amount</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"No amount available for completion request - erroring out"</span><span class="o">);</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">LegacyConversionException</span><span class="o">(</span><span class="n">MALFORMED_REQUEST</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="k">new</span> <span class="n">Amounts</span><span class="o">(</span><span class="n">convertBigDecimalToLong</span><span class="o">(</span><span class="n">amount</span><span class="o">),</span> <span class="n">currency</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="n">BigDecimal</span> <span class="nf">longToBigDecimal</span><span class="p">(</span><span class="kt">long</span> <span class="n">l</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">BigDecimal</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">l</span><span class="o">).</span><span class="na">movePointLeft</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="kt">long</span> <span class="nf">convertBigDecimalToLong</span><span class="p">(</span><span class="n">BigDecimal</span> <span class="n">amount</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">Math</span><span class="o">.</span><span class="na">round</span><span class="o">(</span><span class="n">amount</span><span class="o">.</span><span class="na">doubleValue</span><span class="o">()</span> <span class="o">*</span> <span class="mi">100</span><span class="o">);</span>
<span class="o">}</span>
</code></pre>
</div>

<h2 id="conversion-of-references-from-appflow-requests">Conversion of references from AppFlow requests</h2>

<p>Conversely for example to VOID/REVERSE a completion transaction performed via the POS Flow API you must include the references into the v2 <code class="highlighter-rouge">ReversalRequest</code>.</p>

<p>A <code class="highlighter-rouge">TransactionReferences</code> object can be obtained as below.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="n">TransactionReferences</span> <span class="nf">getReferencesFromAdditionalData</span><span class="p">(</span><span class="n">AdditionalData</span> <span class="n">additionalData</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">LegacyTransactionResult</span> <span class="n">legacyTransactionResult</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LegacyTransactionResult</span><span class="o">();</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">key</span> <span class="o">:</span> <span class="n">additionalData</span><span class="o">.</span><span class="na">getKeys</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">legacyTransactionResult</span><span class="o">.</span><span class="na">addTransactionReference</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">additionalData</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">legacyTransactionResult</span><span class="o">.</span><span class="na">getTransactionReferences</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">static</span> <span class="kd">class</span> <span class="nc">LegacyTransactionResult</span> <span class="kd">extends</span> <span class="n">TransactionResult</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Bundle</span> <span class="n">transactionReferences</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Bundle</span><span class="o">();</span>

    <span class="n">LegacyTransactionResult</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="k">new</span> <span class="n">Bundle</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kt">void</span> <span class="n">addTransactionReference</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">transactionReferences</span><span class="o">.</span><span class="na">putString</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
        <span class="n">getBundle</span><span class="o">().</span><span class="na">putBundle</span><span class="o">(</span><span class="n">ResultOption</span><span class="o">.</span><span class="na">TRANSACTION_REFERENCES</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">transactionReferences</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h3 id="additional-data">Additional data</h3>

<p>The <code class="highlighter-rouge">AdditionalData</code> parameter passed to the method above should be obtained from a valid <code class="highlighter-rouge">TransactionResponse</code> object returned via this API. The API is designed to support multiple transactions and multiple responses per transaction. In most instances however there will only ever be one transaction and one response. Therefore, the previous transaction references can be obtained using.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">TransactionResponse</span> <span class="n">transactionResponse</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getTransactions</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getTransactionResponses</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="n">AdditionalData</span> <span class="n">previousTransactionRefs</span> <span class="o">=</span> <span class="n">transactionResponse</span><span class="o">.</span><span class="na">getReferences</span><span class="o">();</span>
</code></pre>
</div>

<p>Where <code class="highlighter-rouge">response</code> above is the <code class="highlighter-rouge">PaymentResponse</code> object obtained in the <code class="highlighter-rouge">initiatePayment</code> example above. The above is for example only and obviously production code should ideally check the <code class="highlighter-rouge">Transaction</code> list and <code class="highlighter-rouge">TransactionResponse</code> list sizes before attempting to extract the data.</p>

<h3 id="error-messages">Error messages</h3>

<p>Error messages are associated with each <code class="highlighter-rouge">TransactionResponse</code> that they were generated for. Therefore, in order to identify an error message the list of <code class="highlighter-rouge">TransactionResponse</code> objects should be iterated. Again in most situations there will be only a single <code class="highlighter-rouge">TransactionResponse</code>, therefore, as above you can obtain this simply by using the following.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">TransactionResponse</span> <span class="n">transactionResponse</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getTransactions</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getTransactionResponses</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="n">String</span> <span class="n">failureMessage</span> <span class="o">=</span> <span class="n">transactionResponse</span><span class="o">.</span><span class="na">getOutcomeMessage</span><span class="o">();</span>
</code></pre>
</div>

							

						</div><!-- /.c-post -->
					</div><!-- /.o-col -->
				
			</div><!-- /.o-row -->
		</div><!-- /.o-container -->




		
			<footer class="c-footer">
				<div class="o-container">
					<div class="o-row">
						<div class="o-col-12 u-mt-6 u-mt-8@md u-mb-4 u-mb-6@md">
							
								<p class="c-logo u-mb-1">
									AEVI AppFlow
								</p><!-- /.c-logo -->
							
							
								<p>Copyright &copy;2019. - AEVI International GmbH <br>All rights reserved.</p>
							
						</div><!-- /.o-col -->
					</div><!-- /.o-row -->
				</div><!-- /.o-container -->
			</footer><!-- /.c-footer -->
		

		<script type="text/javascript" src="/pos-android-sdk/dox-theme/assets/js/vendor/jquery-3.3.1.min.js"></script>
		<script type="text/javascript" src="/pos-android-sdk/dox-theme/assets/js/scripts.min.js"></script>

		

	</body>
</html>

